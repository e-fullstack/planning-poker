<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport"
              content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <title>Room</title>
        <style>
          body {
            margin-left: auto;
            margin-right: auto;
            width: 50%;
          }
          #error {
              color: red;
          }

        </style>
    </head>
    <body>
      <div id="room__form">
          <h3>Identify yourself in this room</h3>
          <input type="text" name="name" placeholder="Participant Name"/>
          <br/>
          <select name="role">
              <option>Participant</option>
              <option>Observer</option>
          </select>
          <button id="join__button" type="submit" onclick="joinRoom()">Join</button>
      </div>
      <hr>
      <div id="room__info"></div>
      <script>
          const roomId = location.pathname.split("/")[2]
          console.log(roomId)

          const joinRoom = () => {
              const name = document.querySelector("input").value
              const role = document.querySelector("select").value
              if(name) {
                  const user = {name, role}
                  fetch(`/room/${roomId}/member`,{
                      method: 'POST',
                      headers: {
                          'Content-Type': 'application/json'
                      },
                      body: JSON.stringify(user)
                  })
                      .then(r => r.json())
                      .then(r => {
                          console.log(r)
                          //sessionStorage.setItem("user", JSON.stringify({name, role}));
                          const ws = new WebSocket(`ws://localhost:8080/ws/room/${roomId}`)
                          ws.onopen = (e) => {
                              ws.send(JSON.stringify(user));
                          }
                          ws.onmessage = (e) => {
                              document.getElementById("room__info").innerHTML += `<p>${e.data}</p>`
                          }
                          ws.onclose = (e) => {
                              document.getElementById("room__info").innerHTML += `<p>Connection lost</p>`
                          }
                      })
              } else {
                  document.querySelector("input").style.backgroundColor = "yellow";
              }
          }

      </script>
    </body>
</html>